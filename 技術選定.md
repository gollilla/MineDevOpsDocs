# MineDevOps 技術選定・インフラ構成

## 1. システム全体アーキテクチャ

### 1.1 システム構成概要
```
[ユーザー] → [Webアプリ] → [サーバー管理API] → [コンテナオーケストレーション] → [Minecraftサーバー群]
    ↓              ↓                 ↓
[GitHub] → [CI/CDパイプライン] → [プラグインビルド] → [デプロイ]
```

### 1.2 主要コンポーネント
- **Webアプリケーション**: ユーザー管理・ポイント管理・サーバー操作UI
- **サーバー管理API**: Minecraftサーバーの起動・停止・監視
- **コンテナオーケストレーション**: Dockerコンテナによるサーバー管理
- **CI/CDパイプライン**: GitHubからのプラグインビルド・デプロイ

## 2. 技術スタック選定

### 2.1 Webアプリケーション

#### フロントエンド
- **Vue.js 3**: 最新の安定版、Composition API対応
- **InertiaJS**: SPA風のUXを実現、Laravel連携が良好
- **TailwindCSS + DaisyUI**: 高速開発、一貫したデザイン
- **Vite**: 高速ビルド、開発体験向上

#### バックエンド
- **Laravel 11**: 最新LTS、豊富なエコシステム
- **Laravel Breeze**: 軽量認証、Inertia対応
- **Laravel Sail**: Docker環境統合、開発効率向上
- **MySQL 8.0**: 高性能、JSON型サポート

### 2.2 Minecraftサーバー管理

#### コンテナ技術
- **Docker**: サーバー隔離、リソース制限
- **Docker Compose**: 複数サーバー管理
- **Supervisor**: コンテナ内プロセス管理

#### Minecraft実行環境
- **OpenJDK 17/21**: 最新Minecraftバージョン対応
- **Paper**: 高性能、プラグイン互換性
- **Spigot**: 軽量、安定性重視

#### プラグイン管理
- **Maven/Gradle**: ビルドツール自動判定
- **GitHub Actions**: CI/CDパイプライン
- **Webhook**: プッシュトリガー

### 2.3 インフラストラクチャ

#### ホスト環境
- **Ubuntu 22.04 LTS**: 安定性、Docker対応
- **Nginx**: リバースプロキシ、負荷分散
- **Redis**: セッション管理、キャッシュ
- **Supervisor**: プロセス監視

#### 監視・ログ
- **Prometheus + Grafana**: メトリクス監視
- **ELK Stack**: ログ集約・分析
- **Docker Stats API**: リソース使用量監視

## 3. インフラ構成設計

### 3.1 サーバー構成

#### Webサーバー
```
[ロードバランサー] → [Webサーバー1] [Webサーバー2]
                      ↓
[データベース] [Redis] [ファイルストレージ]
```

#### Minecraftサーバーホスト
```
[ホスト1] → [MC Server Container 1] [MC Server Container 2] ...
[ホスト2] → [MC Server Container 3] [MC Server Container 4] ...
```

### 3.2 ネットワーク設計

#### ポート管理
- **動的ポート割り当て**: 25565-35565範囲
- **ポートプール管理**: 使用済みポート追跡
- **ファイアウォール**: 必要ポートのみ開放

#### セキュリティ
- **コンテナ間隔離**: 独立ネットワーク
- **外部通信制限**: Minecraft接続のみ許可
- **プロキシ経由**: 直接IP露出回避

### 3.3 データ管理

#### データベース設計
```sql
-- ユーザー管理
users (id, email, points, created_at)
servers (id, user_id, name, minecraft_version, status)
server_configs (server_id, max_players, github_repo, deploy_branch)

-- ポイント管理  
point_transactions (id, user_id, amount, type, description)
referral_codes (code, user_id, bonus_points)

-- サーバー監視
server_metrics (server_id, cpu_usage, memory_usage, player_count)
deployment_logs (server_id, commit_hash, status, error_message)
```

#### ファイルストレージ
- **サーバーデータ**: Docker Volume
- **プラグインファイル**: 共有ストレージ
- **ログファイル**: ローテーション管理

## 4. 運用・監視設計

### 4.1 自動スケーリング

#### ホスト追加条件
- リソース使用率80%超過
- 起動可能サーバー数が2以下
- 新規サーバー作成要求時

#### サーバー停止管理
- 30秒無接続でGraceful Shutdown
- プレイヤーデータ保存確認
- リソース解放とポート回収

### 4.2 障害対応

#### ヘルスチェック
- Minecraftサーバーping監視
- コンテナ生存確認
- ホストリソース監視

#### 復旧手順
- 自動再起動（3回まで）
- ホスト移動（リソース不足時）
- 手動復旧（重大障害時）

## 5. セキュリティ対策

### 5.1 コンテナセキュリティ
- **非rootユーザー実行**: セキュリティ向上
- **リソース制限**: CPU/メモリ上限設定
- **ファイルシステム制限**: 読み取り専用マウント

### 5.2 ネットワークセキュリティ
- **ポート制限**: 必要最小限のポート開放
- **通信暗号化**: TLS/SSL適用
- **DDoS対策**: レート制限実装

### 5.3 アプリケーションセキュリティ
- **入力値検証**: XSS/SQLインジェクション対策
- **認証・認可**: Laravel標準機能活用
- **ログ監視**: 異常アクセス検知

## 6. 開発・デプロイ戦略

### 6.1 開発環境
- **Laravel Sail**: 統一開発環境
- **Git Flow**: ブランチ戦略
- **自動テスト**: PHPUnit + Jest

### 6.2 CI/CDパイプライン
```
[GitHub Push] → [テスト実行] → [ビルド] → [デプロイ] → [監視]
```

### 6.3 デプロイ戦略
- **Blue-Green Deploy**: 無停止デプロイ
- **Database Migration**: 段階的スキーマ変更
- **Rollback Plan**: 前バージョン復帰機能